<template>
  <div class="avatar-upload">

    <modal 
      name="avatar-crop"
      :classes="['modal', 'avatar-crop']"
      :max-width="600"
      :height="'auto'"
      :scrollable="true"
      :adaptive="true"
    >
      <cropper
        stencil-component="circle-stencil"
        :src="loadedImgSrc"
        class="cropper"
        ref="cropper"
      />

      <button 
        class="btn avatar-crop-button"
        @click="crop"
      >
        Обрезать
      </button>

    </modal>

    <div class="avatar-upload-block">
      <input 
        type="file"
        id="avatar-loader"
        @change.prevent="fileUpload(null)"
      >

      <transition name="fade" mode="out-in">

        <label 
          v-if="$isEmpty(avatarSrc)" 
          key="unloaded"
          for="avatar-loader" 
          class="avatar-upload__container avatar-upload__non-uploaded pointer"
        >

          <svg class="avatar-upload__logo" width="51" height="66" viewBox="0 0 51 66" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M44.3201 17.8333C43.7455 17.8333 43.1944 18.0616 42.788 18.4679C42.3817 18.8743 42.1534 19.4254 42.1534 20V35.1667C42.1534 35.7413 41.9252 36.2924 41.5188 36.6987C41.1125 37.1051 40.5614 37.3333 39.9868 37.3333H9.65344C9.0788 37.3333 8.5277 37.1051 8.12137 36.6987C7.71504 36.2924 7.48677 35.7413 7.48677 35.1667V17.8333C7.48677 17.2587 7.71504 16.7076 8.12137 16.3013C8.5277 15.8949 9.0788 15.6667 9.65344 15.6667H13.9868C14.4592 15.6913 14.9268 15.5607 15.318 15.2946C15.7093 15.0286 16.0027 14.6418 16.1534 14.1933L17.3234 10.64C17.4688 10.2097 17.7457 9.83587 18.1151 9.57149C18.4844 9.30711 18.9275 9.16549 19.3818 9.16667H31.3201C31.8947 9.16667 32.4458 8.93839 32.8522 8.53206C33.2585 8.12574 33.4868 7.57464 33.4868 7C33.4868 6.42536 33.2585 5.87426 32.8522 5.46794C32.4458 5.06161 31.8947 4.83333 31.3201 4.83333H19.2734C17.9118 4.83588 16.5853 5.26598 15.4813 6.06293C14.3772 6.85988 13.5513 7.98343 13.1201 9.275L12.4268 11.4417H9.65344C7.92953 11.4417 6.27623 12.1265 5.05724 13.3455C3.83826 14.5645 3.15344 16.2178 3.15344 17.9417V35.275C3.15344 36.9989 3.83826 38.6522 5.05724 39.8712C6.27623 41.0902 7.92953 41.775 9.65344 41.775H39.9868C41.7107 41.775 43.364 41.0902 44.583 39.8712C45.8019 38.6522 46.4868 36.9989 46.4868 35.275V20.1083C46.5015 19.8148 46.4563 19.5214 46.354 19.2459C46.2517 18.9704 46.0945 18.7186 45.8918 18.5057C45.6891 18.2929 45.4453 18.1236 45.1751 18.008C44.9049 17.8924 44.614 17.833 44.3201 17.8333ZM24.8201 15.6667C23.106 15.6667 21.4304 16.175 20.0052 17.1273C18.5799 18.0796 17.4691 19.4331 16.8131 21.0167C16.1572 22.6004 15.9856 24.3429 16.32 26.0241C16.6544 27.7053 17.4798 29.2495 18.6918 30.4616C19.9039 31.6736 21.4482 32.4991 23.1293 32.8335C24.8105 33.1679 26.5531 32.9963 28.1367 32.3403C29.7203 31.6843 31.0739 30.5735 32.0262 29.1483C32.9785 27.723 33.4868 26.0474 33.4868 24.3333C33.4868 22.0348 32.5737 19.8304 30.9484 18.2051C29.323 16.5798 27.1186 15.6667 24.8201 15.6667ZM24.8201 28.6667C23.9631 28.6667 23.1252 28.4125 22.4126 27.9364C21.7 27.4602 21.1446 26.7834 20.8166 25.9916C20.4886 25.1998 20.4028 24.3285 20.57 23.4879C20.7372 22.6474 21.1499 21.8752 21.756 21.2692C22.362 20.6632 23.1341 20.2505 23.9747 20.0833C24.8153 19.9161 25.6866 20.0019 26.4784 20.3299C27.2702 20.6578 27.947 21.2133 28.4231 21.9259C28.8993 22.6385 29.1534 23.4763 29.1534 24.3333C29.1534 25.4826 28.6969 26.5848 27.8842 27.3975C27.0716 28.2101 25.9694 28.6667 24.8201 28.6667ZM48.6534 4.83333H46.4868V2.66667C46.4868 2.09203 46.2585 1.54093 45.8522 1.1346C45.4458 0.728273 44.8947 0.5 44.3201 0.5C43.7455 0.5 43.1944 0.728273 42.788 1.1346C42.3817 1.54093 42.1534 2.09203 42.1534 2.66667V4.83333H39.9868C39.4121 4.83333 38.861 5.06161 38.4547 5.46794C38.0484 5.87426 37.8201 6.42536 37.8201 7C37.8201 7.57464 38.0484 8.12574 38.4547 8.53206C38.861 8.93839 39.4121 9.16667 39.9868 9.16667H42.1534V11.3333C42.1534 11.908 42.3817 12.4591 42.788 12.8654C43.1944 13.2717 43.7455 13.5 44.3201 13.5C44.8947 13.5 45.4458 13.2717 45.8522 12.8654C46.2585 12.4591 46.4868 11.908 46.4868 11.3333V9.16667H48.6534C49.2281 9.16667 49.7792 8.93839 50.1855 8.53206C50.5918 8.12574 50.8201 7.57464 50.8201 7C50.8201 6.42536 50.5918 5.87426 50.1855 5.46794C49.7792 5.06161 49.2281 4.83333 48.6534 4.83333Z" fill="#B4B4B4"/>
            <path d="M2.80682 63.0837L3.5625 60.762H7.23651L7.99219 63.0837H10.299L6.78906 52.9019H4.01491L0.5 63.0837H2.80682ZM4.10938 59.0816L5.36222 55.2286H5.44176L6.6946 59.0816H4.10938Z" fill="#B4B4B4"/>
            <path d="M11.4007 63.0837H15.1593C17.0683 63.0837 18.1323 62.3032 18.1323 61.0006C18.1323 59.9964 17.3368 59.2009 15.9647 59.1015C17.0584 58.9126 17.7097 58.3358 17.7097 57.5106C17.7097 56.1881 16.5414 55.4474 14.6571 55.4474H11.4007V63.0837ZM13.3745 61.4978V59.8323H15.1593C15.7459 59.8323 16.1039 60.1654 16.1039 60.7073C16.1039 61.1995 15.7459 61.4978 15.1593 61.4978H13.3745ZM13.3745 58.5894V57.0681H14.6571C15.3134 57.0681 15.7161 57.3515 15.7161 57.8188C15.7161 58.301 15.3333 58.5894 14.7019 58.5894H13.3745Z" fill="#B4B4B4"/>
            <path d="M21.5607 63.2279C22.6892 63.2279 23.4201 62.7357 23.7929 62.0248H23.8526V63.0837H25.8611V57.9332C25.8611 56.1135 24.3199 55.3479 22.6196 55.3479C20.7901 55.3479 19.587 56.2229 19.2936 57.615L21.2525 57.7741C21.3966 57.267 21.849 56.8941 22.6097 56.8941C23.3306 56.8941 23.7432 57.257 23.7432 57.8834V57.9133C23.7432 58.4055 23.2212 58.4701 21.8938 58.5993C20.3824 58.7386 19.0252 59.2457 19.0252 60.9509C19.0252 62.4623 20.104 63.2279 21.5607 63.2279ZM22.1672 61.7663C21.5159 61.7663 21.0486 61.463 21.0486 60.8813C21.0486 60.2847 21.5408 59.9914 22.2865 59.887C22.7489 59.8224 23.5046 59.713 23.7581 59.5439V60.3543C23.7581 61.1547 23.0969 61.7663 22.1672 61.7663Z" fill="#B4B4B4"/>
            <path d="M26.667 57.1128H29.1081V63.0837H31.1266V57.1128H33.5875V55.4474H26.667V57.1128Z" fill="#B4B4B4"/>
            <path d="M36.6915 63.2279C37.8201 63.2279 38.5509 62.7357 38.9238 62.0248H38.9834V63.0837H40.9919V57.9332C40.9919 56.1135 39.4508 55.3479 37.7505 55.3479C35.9209 55.3479 34.7178 56.2229 34.4245 57.615L36.3833 57.7741C36.5275 57.267 36.9799 56.8941 37.7405 56.8941C38.4614 56.8941 38.8741 57.257 38.8741 57.8834V57.9133C38.8741 58.4055 38.352 58.4701 37.0246 58.5993C35.5133 58.7386 34.156 59.2457 34.156 60.9509C34.156 62.4623 35.2348 63.2279 36.6915 63.2279ZM37.2981 61.7663C36.6468 61.7663 36.1794 61.463 36.1794 60.8813C36.1794 60.2847 36.6716 59.9914 37.4174 59.887C37.8797 59.8224 38.6354 59.713 38.889 59.5439V60.3543C38.889 61.1547 38.2277 61.7663 37.2981 61.7663Z" fill="#B4B4B4"/>
            <path d="M42.5511 65.9474H44.669V61.8607H44.7336C45.0269 62.4971 45.6682 63.208 46.9012 63.208C48.6413 63.208 49.9985 61.8309 49.9985 59.2755C49.9985 56.6505 48.5816 55.3479 46.9062 55.3479C45.6285 55.3479 45.017 56.1086 44.7336 56.73H44.6391V55.4474H42.5511V65.9474ZM44.6242 59.2655C44.6242 57.9033 45.2009 57.0333 46.23 57.0333C47.279 57.0333 47.8359 57.9431 47.8359 59.2655C47.8359 60.5979 47.2691 61.5226 46.23 61.5226C45.2109 61.5226 44.6242 60.6278 44.6242 59.2655Z" fill="#B4B4B4"/>
          </svg>

        </label>

        <div 
          v-else
          key="loaded"
          class="avatar-upload__container avatar-upload__uploaded"
        >

          <img 
            :src="avatarSrc"
            class="avatar-upload__img"
          >

          <label for="avatar-loader" class="avatar-upload__container avatar-upload__uploaded-overflow">
            <svg width="51" height="66" viewBox="0 0 51 66" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M44.3201 17.8333C43.7455 17.8333 43.1944 18.0616 42.788 18.4679C42.3817 18.8743 42.1534 19.4254 42.1534 20V35.1667C42.1534 35.7413 41.9252 36.2924 41.5188 36.6987C41.1125 37.1051 40.5614 37.3333 39.9868 37.3333H9.65344C9.0788 37.3333 8.5277 37.1051 8.12137 36.6987C7.71504 36.2924 7.48677 35.7413 7.48677 35.1667V17.8333C7.48677 17.2587 7.71504 16.7076 8.12137 16.3013C8.5277 15.8949 9.0788 15.6667 9.65344 15.6667H13.9868C14.4592 15.6913 14.9268 15.5607 15.318 15.2946C15.7093 15.0286 16.0027 14.6418 16.1534 14.1933L17.3234 10.64C17.4688 10.2097 17.7457 9.83587 18.1151 9.57149C18.4844 9.30711 18.9275 9.16549 19.3818 9.16667H31.3201C31.8947 9.16667 32.4458 8.93839 32.8522 8.53206C33.2585 8.12574 33.4868 7.57464 33.4868 7C33.4868 6.42536 33.2585 5.87426 32.8522 5.46794C32.4458 5.06161 31.8947 4.83333 31.3201 4.83333H19.2734C17.9118 4.83588 16.5853 5.26598 15.4813 6.06293C14.3772 6.85988 13.5513 7.98343 13.1201 9.275L12.4268 11.4417H9.65344C7.92953 11.4417 6.27623 12.1265 5.05724 13.3455C3.83826 14.5645 3.15344 16.2178 3.15344 17.9417V35.275C3.15344 36.9989 3.83826 38.6522 5.05724 39.8712C6.27623 41.0902 7.92953 41.775 9.65344 41.775H39.9868C41.7107 41.775 43.364 41.0902 44.583 39.8712C45.8019 38.6522 46.4868 36.9989 46.4868 35.275V20.1083C46.5015 19.8148 46.4563 19.5214 46.354 19.2459C46.2517 18.9704 46.0945 18.7186 45.8918 18.5057C45.6891 18.2929 45.4453 18.1236 45.1751 18.008C44.9049 17.8924 44.614 17.833 44.3201 17.8333ZM24.8201 15.6667C23.106 15.6667 21.4304 16.175 20.0052 17.1273C18.5799 18.0796 17.4691 19.4331 16.8131 21.0167C16.1572 22.6004 15.9856 24.3429 16.32 26.0241C16.6544 27.7053 17.4798 29.2495 18.6918 30.4616C19.9039 31.6736 21.4482 32.4991 23.1293 32.8335C24.8105 33.1679 26.5531 32.9963 28.1367 32.3403C29.7203 31.6843 31.0739 30.5735 32.0262 29.1483C32.9785 27.723 33.4868 26.0474 33.4868 24.3333C33.4868 22.0348 32.5737 19.8304 30.9484 18.2051C29.323 16.5798 27.1186 15.6667 24.8201 15.6667ZM24.8201 28.6667C23.9631 28.6667 23.1252 28.4125 22.4126 27.9364C21.7 27.4602 21.1446 26.7834 20.8166 25.9916C20.4886 25.1998 20.4028 24.3285 20.57 23.4879C20.7372 22.6474 21.1499 21.8752 21.756 21.2692C22.362 20.6632 23.1341 20.2505 23.9747 20.0833C24.8153 19.9161 25.6866 20.0019 26.4784 20.3299C27.2702 20.6578 27.947 21.2133 28.4231 21.9259C28.8993 22.6385 29.1534 23.4763 29.1534 24.3333C29.1534 25.4826 28.6969 26.5848 27.8842 27.3975C27.0716 28.2101 25.9694 28.6667 24.8201 28.6667ZM48.6534 4.83333H46.4868V2.66667C46.4868 2.09203 46.2585 1.54093 45.8522 1.1346C45.4458 0.728273 44.8947 0.5 44.3201 0.5C43.7455 0.5 43.1944 0.728273 42.788 1.1346C42.3817 1.54093 42.1534 2.09203 42.1534 2.66667V4.83333H39.9868C39.4121 4.83333 38.861 5.06161 38.4547 5.46794C38.0484 5.87426 37.8201 6.42536 37.8201 7C37.8201 7.57464 38.0484 8.12574 38.4547 8.53206C38.861 8.93839 39.4121 9.16667 39.9868 9.16667H42.1534V11.3333C42.1534 11.908 42.3817 12.4591 42.788 12.8654C43.1944 13.2717 43.7455 13.5 44.3201 13.5C44.8947 13.5 45.4458 13.2717 45.8522 12.8654C46.2585 12.4591 46.4868 11.908 46.4868 11.3333V9.16667H48.6534C49.2281 9.16667 49.7792 8.93839 50.1855 8.53206C50.5918 8.12574 50.8201 7.57464 50.8201 7C50.8201 6.42536 50.5918 5.87426 50.1855 5.46794C49.7792 5.06161 49.2281 4.83333 48.6534 4.83333Z" fill="#B4B4B4"/>
              <path d="M2.80682 63.0837L3.5625 60.762H7.23651L7.99219 63.0837H10.299L6.78906 52.9019H4.01491L0.5 63.0837H2.80682ZM4.10938 59.0816L5.36222 55.2286H5.44176L6.6946 59.0816H4.10938Z" fill="#B4B4B4"/>
              <path d="M11.4007 63.0837H15.1593C17.0683 63.0837 18.1323 62.3032 18.1323 61.0006C18.1323 59.9964 17.3368 59.2009 15.9647 59.1015C17.0584 58.9126 17.7097 58.3358 17.7097 57.5106C17.7097 56.1881 16.5414 55.4474 14.6571 55.4474H11.4007V63.0837ZM13.3745 61.4978V59.8323H15.1593C15.7459 59.8323 16.1039 60.1654 16.1039 60.7073C16.1039 61.1995 15.7459 61.4978 15.1593 61.4978H13.3745ZM13.3745 58.5894V57.0681H14.6571C15.3134 57.0681 15.7161 57.3515 15.7161 57.8188C15.7161 58.301 15.3333 58.5894 14.7019 58.5894H13.3745Z" fill="#B4B4B4"/>
              <path d="M21.5607 63.2279C22.6892 63.2279 23.4201 62.7357 23.7929 62.0248H23.8526V63.0837H25.8611V57.9332C25.8611 56.1135 24.3199 55.3479 22.6196 55.3479C20.7901 55.3479 19.587 56.2229 19.2936 57.615L21.2525 57.7741C21.3966 57.267 21.849 56.8941 22.6097 56.8941C23.3306 56.8941 23.7432 57.257 23.7432 57.8834V57.9133C23.7432 58.4055 23.2212 58.4701 21.8938 58.5993C20.3824 58.7386 19.0252 59.2457 19.0252 60.9509C19.0252 62.4623 20.104 63.2279 21.5607 63.2279ZM22.1672 61.7663C21.5159 61.7663 21.0486 61.463 21.0486 60.8813C21.0486 60.2847 21.5408 59.9914 22.2865 59.887C22.7489 59.8224 23.5046 59.713 23.7581 59.5439V60.3543C23.7581 61.1547 23.0969 61.7663 22.1672 61.7663Z" fill="#B4B4B4"/>
              <path d="M26.667 57.1128H29.1081V63.0837H31.1266V57.1128H33.5875V55.4474H26.667V57.1128Z" fill="#B4B4B4"/>
              <path d="M36.6915 63.2279C37.8201 63.2279 38.5509 62.7357 38.9238 62.0248H38.9834V63.0837H40.9919V57.9332C40.9919 56.1135 39.4508 55.3479 37.7505 55.3479C35.9209 55.3479 34.7178 56.2229 34.4245 57.615L36.3833 57.7741C36.5275 57.267 36.9799 56.8941 37.7405 56.8941C38.4614 56.8941 38.8741 57.257 38.8741 57.8834V57.9133C38.8741 58.4055 38.352 58.4701 37.0246 58.5993C35.5133 58.7386 34.156 59.2457 34.156 60.9509C34.156 62.4623 35.2348 63.2279 36.6915 63.2279ZM37.2981 61.7663C36.6468 61.7663 36.1794 61.463 36.1794 60.8813C36.1794 60.2847 36.6716 59.9914 37.4174 59.887C37.8797 59.8224 38.6354 59.713 38.889 59.5439V60.3543C38.889 61.1547 38.2277 61.7663 37.2981 61.7663Z" fill="#B4B4B4"/>
              <path d="M42.5511 65.9474H44.669V61.8607H44.7336C45.0269 62.4971 45.6682 63.208 46.9012 63.208C48.6413 63.208 49.9985 61.8309 49.9985 59.2755C49.9985 56.6505 48.5816 55.3479 46.9062 55.3479C45.6285 55.3479 45.017 56.1086 44.7336 56.73H44.6391V55.4474H42.5511V65.9474ZM44.6242 59.2655C44.6242 57.9033 45.2009 57.0333 46.23 57.0333C47.279 57.0333 47.8359 57.9431 47.8359 59.2655C47.8359 60.5979 47.2691 61.5226 46.23 61.5226C45.2109 61.5226 44.6242 60.6278 44.6242 59.2655Z" fill="#B4B4B4"/>
            </svg>
          </label>

        </div>

      </transition>
    </div>

    

  </div>
</template>

<script>
import { Cropper, CircleStencil } from 'vue-advanced-cropper';

export default {
  components: { Cropper, CircleStencil },
  props: {
    avatar: String
  },
  data() {
    return {
      file: null,
      loaderContainer: null,
      loadedImgSrc: '',
      avatarSrc: '',
      events: ['drag', 'dragstart', 'dragend', 'dragover', 'dragenter', 'dragleave', 'drop']
    }
  },
  mounted() {
    this.eventsInit()
  },
  created() {
    this.avatarSrc = this.avatar
  },
  methods: {
    eventsInit() {

      this.loaderContainer = document.querySelector('.avatar-upload__non-uploaded') || document.querySelector('.avatar-upload__uploaded-overflow')

      this.events.forEach(function(evt) {
        this.loaderContainer.addEventListener(evt, this.addDefaultEvent)
      }.bind(this));

      document.addEventListener('dragenter', this.dragEnter)

      document.addEventListener('dragleave', this.dragLeave)

      this.loaderContainer.addEventListener('drop', this.drop)

    },
    addDefaultEvent() {
      event.preventDefault();
      event.stopPropagation();
    },
    drop() {
      this.fileUpload(event.dataTransfer.files[0])
    },
    dragEnter() {
      console.log('dragEnter')
    },
    dragLeave() {
      console.log('dragLeave')
    },
    fileUpload(droppedFile) {

      const file = (droppedFile) ? droppedFile : event.target.files[0]

      this.file = file

      if (!file.type.includes('image')) {

        this.$root.showNotification({
          title: 'Неверный формат файла',
          type: 'error'
        })

        return

      }

      let reader = new FileReader()

      let vm = this

      reader.addEventListener("load", function() {

        let img = new Image()

        img.addEventListener('load', function() {
          
          // if (this.width >= 1920 && this.height >= 400) {

            // vm.avatarSrc = reader.result
            vm.loadedImgSrc = reader.result
            // vm.$emit('fileUpload', file)

            console.log(file)

            vm.$modal.show('avatar-crop')
            vm.eventsInit()

          // } else {

          //   vm.$root.showNotification({
          //     title: 'Изображение не соответствует минимальным размерам 1920×400',
          //     type: 'error'
          //   })

          // }
          
        })

        img.src = reader.result

        // let data = new FormData()

        // data.append("file", file)

      })

      reader.readAsDataURL(file)

    },
    crop() {

      const { canvas, image } = this.$refs.cropper.getResult()

      this.avatarSrc = image.src

      canvas.toBlob((blob) => {
        this.$emit('fileUpload', blob)
        this.$modal.hide('avatar-crop')
      }, this.file.type)

    }
  }
}
</script>